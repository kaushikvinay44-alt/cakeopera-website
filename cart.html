<!doctype html>
<html lang="en">
<head>
  <!-- Razorpay Checkout SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your Cart â€” Cakeopera Checkout</title>
  <link rel="stylesheet" href="styles.css">

  <style>
    .cart-page{ max-width:1000px; margin:28px auto; padding:0 20px;}
    .cart-table{ width:100%; border-collapse:collapse; margin-bottom:18px;}
    .cart-table th, .cart-table td{ padding:12px; text-align:left; border-bottom:1px solid #eee;}
    .cart-thumb{ width:72px; height:72px; object-fit:cover; border-radius:8px; }
    .checkout-panel{ background:#fff; padding:16px 18px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.06); margin-top:18px;}
    .pay-method label{ margin-right:18px; }
    .btn-pay{ background:#e05572; color:#fff; border:none; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:700;}
    .error-text{ color:#d9534f; margin-top:8px; font-size:0.9rem; }
  </style>
</head>
<body>
  <header>
    <a class="brand" href="index.html">
      <img src="images/logo.png" alt="Cakeopera logo">
      <span>Cakeopera</span>
    </a>
    <nav>
      <a href="index.html#menu">Menu</a>
      <a href="courier.html">Courier</a>
      <a href="cart.html">Cart</a>
      <a href="index.html#contact">Contact</a>
    </nav>
  </header>

  <main class="cart-page">
    <h1>Your Cart</h1>

    <!-- Cart items are rendered by cart-handler.js -->
    <div id="cart-container"></div>

    <!-- Order summary + payment -->
    <section class="checkout-panel">
      <h2>Order Summary</h2>

      <p>Subtotal:
        <strong>â‚¹<span id="cart-subtotal-amount">0</span></strong>
      </p>
      <p>Courier shipping:
        <strong>â‚¹<span id="cart-shipping-amount">0</span></strong>
      </p>
      <p>Total:
        <strong>â‚¹<span id="cart-total-amount" data-amount="0">0</span></strong>
      </p>

      <h3 style="margin-top:16px;">Select Payment</h3>
      <div class="pay-method">
        <label>
          <input type="radio" name="pay-method" checked>
          Razorpay
        </label>
      </div>

      <button id="payPlaceOrder" class="btn-pay">Pay / Place Order</button>
      <p id="paymentError" class="error-text"></p>
    </section>
  </main>

  <footer>
    <p>Â© <span id="year"></span> Cakeopera</p>
  </footer>

  <!-- Your main scripts -->
  <script src="script.js"></script>
  <script src="cart-handler.js"></script>

  <!-- Razorpay + backend integration -->
  <script>
    const BACKEND_BASE_URL = "https://cakeopera-backend.onrender.com";
    const RAZORPAY_KEY_ID = "rzp_live_RnaCiQ6aqxCqmG"; // use test key if needed

    async function createCakeoperaOrder(totalAmountInRupees) {
      const amountInPaise = Math.round(totalAmountInRupees * 100);

      const response = await fetch(BACKEND_BASE_URL + "/create-order", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ amount: amountInPaise })
      });

      const data = await response.json();

      if (!data || (!data.ok && !data.success)) {
        throw new Error(data && data.error ? data.error : "Order creation failed");
      }

      return data.order;
    }

    function getCartTotalFromPage() {
      const totalSpan = document.getElementById("cart-total-amount");
      if (!totalSpan) return 0;

      const raw = totalSpan.dataset.amount || totalSpan.textContent;
      const numeric = parseFloat(String(raw).replace(/[^\d.]/g, "")) || 0;
      return numeric;
    }

    async function openRazorpayCheckout(totalAmountInRupees) {
      const errorEl = document.getElementById("paymentError");
      if (errorEl) errorEl.textContent = "";

      try {
        const order = await createCakeoperaOrder(totalAmountInRupees);

        const options = {
          key: RAZORPAY_KEY_ID,
          amount: order.amount,
          currency: order.currency || "INR",
          name: "Cakeopera",
          description: "Courier Order Payment",
          order_id: order.id,
          handler: function (response) {
            alert("Payment Successful! ðŸŽ‰");
            console.log("Razorpay response:", response);

            // Example: clear cart + redirect
            // localStorage.removeItem("cakeoperaCart");
            // window.location.href = "thankyou.html";
          },
          prefill: {
            name: "Customer",
            email: "customer@example.com",
            contact: "9876543210"
          },
          theme: {
            color: "#E91E63"
          }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error("Payment error:", err);
        if (errorEl) {
          errorEl.textContent = "Order creation failed: " + err.message;
        } else {
          alert("Order creation failed: " + err.message);
        }
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      const payBtn = document.getElementById("payPlaceOrder");
      if (!payBtn) return;

      payBtn.addEventListener("click", function (e) {
        e.preventDefault();

        const totalAmountInRupees = getCartTotalFromPage();
        if (totalAmountInRupees <= 0) {
          alert("Cart total must be greater than 0.");
          return;
        }

        openRazorpayCheckout(totalAmountInRupees);
      });
    });
  </script>
</body>
</html>
